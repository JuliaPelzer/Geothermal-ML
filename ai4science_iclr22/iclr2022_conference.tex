
\documentclass{article} % For LaTeX2e
\usepackage{iclr2022_conference,times}

% Optional math commands from https://github.com/goodfeli/dlbook_notation.
\input{math_commands.tex}

\usepackage{hyperref}
\usepackage{url}
\usepackage{graphicx}
\usepackage{cleveref}
\usepackage{todonotes}
\setuptodonotes{inline}
\usepackage{tikz}
\usepackage{caption}
\usepackage{subcaption}

\definecolor{blue1}{RGB}{0,102,189}
\definecolor{blue2}{RGB}{98,160,214}
\definecolor{my_orange}{RGB}{243,98,33}
\definecolor{mygreen}{RGB}{30,106,57}
\definecolor{mypurple}{RGB}{91,39,125}
\definecolor{myred}{RGB}{241,13,12}

\def\boxit#1{%
  \smash{\color{black}\fboxrule=1pt\relax\fboxsep=2pt\relax%
  \llap{\rlap{\fbox{\vphantom{0}\makebox[#1]{}}}~}}\ignorespaces
}
\input{tikzstyles.tex}


%\title{Formatting Instructions for ICLR 2022 \\ Conference Submissions}
\title{Surrogate Modelling of Thermal Plumes for Shallow Subsurface Temperature Approximation}

% Authors must not appear in the submitted version. They should be hidden
% as long as the \iclrfinalcopy macro remains commented out below.
% Non-anonymous submissions will be rejected without review.

\author{Antiquus S.~Hippocampus, Natalia Cerebro \& Amelie P. Amygdale \thanks{ Use footnote for providing further information
about author (webpage, alternative address)---\emph{not} for acknowledging
funding agencies.  Funding acknowledgements go at the end of the paper.} \\
Department of Computer Science\\
Cranberry-Lemon University\\
Pittsburgh, PA 15213, USA \\
\texttt{\{hippo,brain,jen\}@cs.cranberry-lemon.edu} \\
\And
Ji Q. Ren \& Yevgeny LeNet \\
Department of Computational Neuroscience \\
University of the Witwatersrand \\
Joburg, South Africa \\
\texttt{\{robot,net\}@wits.ac.za} \\
\AND
Coauthor \\
Affiliation \\
Address \\
\texttt{email}
}

% The \author macro works with any number of authors. There are two commands
% used to separate the names and addresses of multiple authors: \And and \AND.
%
% Using \And between authors leaves it to \LaTeX{} to determine where to break
% the lines. Using \AND forces a linebreak at that point. So, if \LaTeX{}
% puts 3 of 4 authors names on the first line, and the last on the second
% line, try using \AND instead of \And before the third author name.

\newcommand{\fix}{\marginpar{FIX}}
\newcommand{\new}{\marginpar{NEW}}

%\iclrfinalcopy % Uncomment for camera-ready version, but NOT for submission.
\begin{document}


\maketitle

\begin{abstract}
   The abstract paragraph should be indented 1/2~inch (3~picas) on both left and
   right-hand margins. Use 10~point type, with a vertical spacing of 11~points.
   The word \textsc{Abstract} must be centered, in small caps, and in point size 12. Two
   line spaces precede the abstract. The abstract must be limited to one
   paragraph.
\end{abstract}

\section{Introduction}
\label{sec:intro}

Heating and cooling of buildings has garnered attention in recent years, especially as the world moves towards renewable sources of energy. 
%It is estimated up to three quarters of the worlds fossil fuels used in buildings goes towards heating (The Economist).
%In a world moving towards renewables ernergy as main 
One focus recently has been on using grounwater heat pumps (GWHP) \cite{Halilovic2022}, utlizing the shallow geothermal energy. 
As the grounwater temperature is relatively stable year round, GWHP's are able to use this source to both heat and cool buildings. %(https://www.energy.gov/energysaver/geothermal-heat-pumps) 

As cities move towards installing more GWHP's, assessing and optimizing their influence on the subsurface is required. 
Installing teh GWHP's without any restrictions could result in situations where negative interaction occurs \cite{Garcia2020, Daemi2019}. 
GWHP's operate by extracting water from an extraction well, either heating or cooling this fluid, and reinjecting this fluid back into the subsurface.  
Due to the operation of a GWHP, the local temperature around the GWHP changes, and a thermal plume develops due to the diffusion and advection of this water in the subsurface. 
This thermal plume can propogate downstream and interact with other GWHP's or even recirculate into its own extraction well, causing interference. 
This requires careful planning of the layout and operational loads of GWHP's \cite{Beck2013}. 
To provide an accurate assessment of the groundwater temperatures due to the usage of many heat pumps, high-fidelity subsurface flow simulations are required \cite{Meng2019}. 
Furthermore, to optimize the layout and usage of a large number of GWHP's on this scale requires many high-fidelity simulation runs, making large optimization scenarios infeasible.

A common solution is to use surrogate models, also known as low-fidelity models, which are computationally cheap to solve the optimization problem \cite{Sbai2019, Nagoor2019, Robinson2012}. 
To help optimize the layout of potentially thousands of GWHP's, surrogate models could be used to determine the local temperature influence that each GWHP has on the groundwater temperature. 
As the thermal influence of one heat pump can be computed fast and cheaply, many such evaluations can be performed to determine the influence of multiple heat pumps in a system. 
This can be used to provide either a semi-optimised solution, or to evaluate the influence of one heat pump on other previously installed heat pumps. 

We need to model the local temperature variation that develops, i.e. determine the thermal plume. 
Analytical solutions provide a computationally cheap solution \cite{Pophillat2020}, but suffer from several disadvantages. 
The analytical solutions do not account for variations in the groundwater parameters in space, such as varying permeability field, pressure gradients and velocity fields. 
This results in the thermal plume extending in one direction only for the analytical solutions, however, the thermal plumes may change their direction due to heterogenous groundwater parameters. 

\begin{figure}
\centering
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{analyticalPlume.png}
  \caption{Analytical thermal plume}
  \label{analyticalPlume}
\end{subfigure}%
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{large_temp_example_2.png}
  \caption{Temperature of 10 GWHP's}
  \label{large_example}
\end{subfigure}
\caption{The thermal plume developed by (a) GWHP derived from the LAHM model and (b) 10 GWHP's in a large domain using a spatially varying permeability field. The thermal plume in (a) is uni-directional for the analytical model, and is dependent only on the parameters at the location of reinjection. A more realistic example in (b) shows that the thermal plumes follow the velocity direction of the subsurface.}
\label{fig:test}
\end{figure}

%One crucial development of the past decade to achieve this is the widespread adoptioln of more energy efficient and carbon-free techniques for heating and cooling urban buildings.
%A central role plays the usage of heatpumps extracting energy from subsurface groundwater 

%Establishing this technology on a large city-wide scale however, requires some regulatory oversight for the locations and energetic dimensions of installed heatpumps.
%Installing these without any restrictions might result in situations where the heat injection/substraction from one pump might negatively impact the performance of another pump down-stream.

%In a first step to address this optimization problem this work aims at providing a web-based tool for city planners to quickly test out different placement scenarios.
%Using a machine learning surrogates we want to predict physically accurate temperature fields in real-time based in the users input and measured groundwater flow fields of a large European city.

%- general motivation (large scale heatpump adoption requires optimization of placements etc.)
%\begin{enumerate}
%\item The large scale roll-out of shallow groundwater heat pumps often results in thermal interference of the installed heat pumps.
%\item This requires optimization of placement and usage of heat pumps to manage the subsurface thermal resource.
%\item Current analytical formulas are too simplistic.
%\end{enumerate}

%- geokw project outline (possibly de-anonymizing?) \\
%KD: We can remove GeoKW and I can explain the project. The web-app isnt live so they wouldn't be able to find it.

%- specific application in web-based real-time context -> requires fast online evaluation
%\begin{enumerate}
%\item Specific application is the optimization, as this is crazy expensive. Try to reduce computational time of the optimization.
%\item Second application is a web-based planning tool, which gives energy planners an easy tool to assess compatability.
%\end{enumerate}

%\textbf{Related Work}
The optimization problem consists of a large area (such as in Fig.~\ref{large_example}), with known input parameters: spatially varying permeability field and pressure boundary conditions. 
The surrogate model would be able to provide the local temperature variation around each GWHP (Fig.~\ref{fig:sub1_temp}), and we can determine which GWHP's might interact with each other.


\section{Method}
\label{sec:method}

In this section we describe the model setup and data generation. 
Machine learning based surrogates for physical applications has increased dramatically in recent years \cite{Vinuesa2021,Laubscher2021,Chen2021,Zhu2019,Thuerey2019}. 
%Equally the number of different approaches is quite diverse.
A popular method is the physics-informed neural networks (PINN), where a neural network is not trained using typical data sources, but trained such that the PINN output must satisfy some specific boundary-value problem \cite{pinn}. 
In the case of a partial differential equation (PDE), the residual is added to the neural network loss function, and the network is trained to minimize this residual. Therefore, the PINN output should satisfy the underlying physical laws of the PDE. 
%One of these are physics-informed methods where a neural network (NN) is trained to approximate the solution of a specific boundary-value problem \cite{pinn}.
%This works by adding the PDE residual of the underlying equations to the loss function and thus optimizing the network for solutions which obey the underlying physical laws.
Other approaches such as CFDNet \cite{cfdnet} include an neural network surrogate as a pre-conditioner inside a traditional numerical solver, whereas other works utilise PINN's to provide error correction for coarse scale models \cite{Gao2021}. 

\subsection{Surrogate Model}

The surrogate model only needs to solve for the local temperature field around a GWHP. 
We solve for the boundary value problem using a finite volume subsurface solver to determine the pressure field, velocity field and temperature field. 
%However, we assume that the velocity field is is only locally influenced by a GWHP, and we can therefore run our model without any GWHP's installed to determine an initial pressure and velocity field.  
We assume that the subsurface temperature is domniated by the advection term in the darcy flow equations, and the temperature profile follows the velocity field profile. 
Therefore, our aim is to develop a neural network that uses the spatially varying, steady-state groundwater velocity field as an input, and outputs the thermal plume that develops due to the additional of a single GWHP in a smaller domain. 


\subsection*{Dataset Description}

In order to train the neural network, we need to provide enough training data such that the thermal plume can be accurately captured. We use PFLOTRAN to perform the high-fidelity subsurface simulations \cite{pflotran-paper}. We consider a 2D domain with directions $x$ and $y$, and darcy velocities $q_x$ and $q_y$. The darcy velocities are used as inputs to the neural network. The training data simulations are performed on a 64x64 structured grid with 4096 cells, covering an area of 128$m$ $\times$ 128$m$ $\times$ 1$m$. A mass injection of 0.01 $kg \cdot s^{-1}$ is used for the heat pump, and run for a total of 720 days to achieve a pseudo steady state solution.

%\begin{figure}[h]
%\centering
%\begin{tikzpicture}[scale=2, every node/.style={font=\small}]

%\coordinate(origin) at (0,0);

%\coordinate(fluidWidth) at (2,0);
%\coordinate(fluidHeight) at (0,2);

%\coordinate(fluidBottomLeft) at ($(origin)$);
%\coordinate(fluidTopRight) at ($(origin) + (fluidWidth) + (fluidHeight)$);

%\draw[fill=participantBcolor!50](fluidBottomLeft) rectangle (fluidTopRight);
%\dimline[extension start length=0, extension end length=0] {($(0,2)+(0,.21)$)}{($(2,2)+(0,.21)$)}{$L$};

%\draw($(0.05,0.98)$) -- node[right, black, align=right]{$\Gamma_\text{inlet}$} ($(0.05,0.98)$);  % inlet
%\draw($(0.85,0.15)$) -- node[right, black, align=right]{$\Gamma_\text{inlet}$} ($(0.85,0.15)$);  % inlet
%\draw($(1.5,0.98)$) -- node[right, black, align=right]{$\Gamma_\text{outlet}$} ($(1.5,0.98)$);  % outlet
%\draw($(0.855,1.78)$) -- node[right, black, align=right]{$\Gamma_\text{outlet}$} ($(0.85,1.78)$);  % outlet

%\end{tikzpicture}
%\end{figure}

\begin{figure}
\centering
\begin{subfigure}{.33\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{perm_example.png}
  \caption{Permeability Field}
  \label{fig:sub1_perm}
\end{subfigure}%
\begin{subfigure}{.33\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{pressure_example.png}
  \caption{Pressure Field}
  \label{fig:sub1_pressure}
\end{subfigure}
\begin{subfigure}{.33\textwidth}
  \centering
  \includegraphics[width=.8\linewidth]{temp_example.png}
  \caption{Temperature Field}
  \label{fig:sub1_temp}
\end{subfigure}%
\caption{The permeability, pressure and temperature field for an training data example. The temperature plume that develops from the GWHP is not uni-directional like the analytical solutions, and depends highly on the velocity direction.}
\label{fig:test}
\end{figure}


%\todo{to train fast surrogate we need data}

%\todo{data is generated using FV solver pflotran for different configurations}

The training is generated by varying the permeability field and pressure boundary conditions to generate "randomly" varying velocity fields. The permeability field is generated by using the Python Random module to pseudo-randomly assign values between $(-1 , 1)$ at various points on a square grid throughout the domain. These values are then mapped to the PFLOTRAN grid using the radial basis function (RBF) interpolation method, using thin-plate-splines basis functions. These values are then rescaled and converted into the permeability field values. And example permeability field in shown in Fig.~\ref{fig:sub1_perm}. We created 6 sets of data with which to train the model. Three data sets use a relatively coarse grid 4 $\times$ 4 grid for the RBF interpolation onto the PFLOTRAN grid, and another three data sets with a 8 $\times$ 8 grid. Each of these three data sets have a maximum and minimum permeability value of: $1.1 \cdot 10^{-7}$ - $5.6 \cdot 10^{-9}$, $4.1 \cdot 10^{-8}$ - $2.1 \cdot 10^{-9}$ and $1.5 \cdot 10^{-8}$ - $7.6 \cdot 10^{-10}$.

The pressure gradient applied to the domain is also generated using the \textit{random} library in python. Two random values for the $x$ and $y$ direction gradient is applied. Only positive gradient values are applied in the $x$ direction $(0 , 1)$, whereas the $y$ direction is allowed to vary between $(-1 , 1)$. This generate velocity fields in the positive $x$ direction only, however we can rotate the data during training. 

This allows us to generate many varying velocity fields, and due to the small size of the FV solver, the simulations are computationally cheap.


\todo{underlying equations are the (stationary) Richards flow equations}

\todo{generate arbitrary configurations with smooth random flow fields}

\todo{injection in the middle of the domain leads to some temperature plume}

\todo{we solve a bunch of these until a quasi-stationary state is achieved}

The steady state mass conservation is determined by 
\begin{equation}
   \label{eq:mass}
   \nabla \cdot \left(\eta \vq \right) =  \nabla \cdot \left(\eta  K \nabla P  \right) = Q_w
\end{equation}

where $Q_w$ is the mass flow source term, which is non-zero only at the boundaries and at the center where mass is injected into the groundwater by the GWHP. The steady state thermal hydraulic solution is determined by

\begin{equation}
   \label{eq:energy}
   \nabla \cdot \left(\eta \vq H\right) - \kappa \Delta T = Q_e
\end{equation}

with the energy source term $Q_e$, enthalpy $H$, thermal conductivity $\kappa$ and temperature $T$. 
%with energy source term $Q_e$ in $MW/m^2$ as well as mass source term $Q_w$ in $kmol\, m^{-3} s^{-1}$ and darcy flux $\vq$ in $m/s$

\begin{tabular}{| c | c | c |}
   \hline
   $\eta$   & molar density        & $55.3454010547$ $kmol/m^3$ \\
   \hline
   $\kappa$ & thermal conductivity & $0.5 W/(mK)$                   \\
   \hline
   H        & specific enthalpy of water             & $1.134945 kJ/mol$                  \\
   \hline
\end{tabular}

\todo{Data augmentation?}


\subsection*{Model}
\todo{as surrogate we use a TurbNet structure}
\begin{figure}[htb]
   \centering
   \includegraphics[width=9cm]{example-image-a}
   \caption{Visualization of the network architecture. The encode and decoder paths feature a 2d convultions with a kernlsize of $4$. Both paths are connected via skip connections in each level.}
   \label{fig:arch}
\end{figure}

For our surrogate model, we chose a slightly modified version of the ``TurbNet'' architecture as described in \cite{Thuerey2019}.
The general shape is similar to a simple ``UNet'' \cite{Ronneberger2015} where the input is convolved into coarser and coarser features on a contracting path until a bottleneck level is reached. 
%This is done until a bottleneck level is reached. 
From this on the feature channels are again deconvolved in a symmetric fashion upwards.
Additionally, each step in the hierarchy also includes a skip connection, copying intermediate results from the contracting path and concatenating it feature wise to the results of the expanding path.
A graphical overview is depicted in Figure \ref{fig:arch}

\todo{why did we choose this?}

\todo{what is "slightly modified"?}

\todo{- network description here}
\todo{- this allows us to directly predict stationary temperature plume for a given flow field}
\todo{- this surrogate can then be used in a real-time setting to make predictions for the website user}


\subsubsection*{Physical Constraints}
Additionally, we use \cref{eq:mass,eq:energy} to regularize the network during training.
By ensuring that both of these are fulfilled for predictions of the model we steer the training process towards physically plausible solutions which obey mass and energy conservation.
To achieve this we first calculate the residuals for both equations using sobel filters to get the gradient/divergence fields.
These residuals are then added to the loss function of the optimizer.

\todo{- using these we can additionally regularize the network during training}
\todo{- makes sure that physically plausible solutions are found}
\todo{- should be more robust?}
\todo{- comparison with and without physical term (speeds up training?)}



\section{Results}
\label{sec:results}

\todo{- Data description}

- Data generation (using PFLOTRAN)
\begin{enumerate}
\item Randomly generate permeability fields and pressure boundaries to generate velocity fields.
\item Simulate this with added heat flux to determine temperatures
\end{enumerate}

\todo{- model setup}
\begin{figure}[htb]
   \centering
   \includegraphics[width=5cm]{example-image-a}
   \caption{Example visualization of a single data sample. Streamlines represent the darcy flow velocity overlay over a plot of the temperature.}
\end{figure}

\todo{- evaluation (error on test set, inference time)}


\begin{figure}[htb]
   \centering
   \includegraphics[width=10cm,height=6cm]{example-image-a}
   \caption{Example screenshot of a web app showing multiple hand placed heatpumps on a city map with heat plumes being generated using the surrogate model.}
\end{figure}
\todo{- overlay of local surrogates on city map (?)}

\section{Conclusion}
\label{sec:conclusion}



\todo{- future work: overlapping local predictions $\rightarrow$ resolve with global city-wide model}

In the future we would like to expand the surrogate model by also including a heatpump's power as a parametric input.
Furthermore a shortcoming of the current approach is that overlapping temperature plumes are not considered.
Even though in this application that scenario is not desirable, other applications might need such interaction.
To deal with this another extension could be stitching together multiple local surrogate predictions and then using that as a preconditioned starting position for solving a traditional large scale numerical model of the whole city domain.

- Web app currently uses analytical formulas. Want to add this as it uses non-uniform velocities.

%\input{backmatter.tex}

\bibliography{iclr2022_conference}
\bibliographystyle{iclr2022_conference}

\appendix
\section{Appendix}
You may include other additional sections here.

\end{document}
